# æ¸…ç†ç¯å¢ƒ
rm(list = ls())

# ------------------------
# åŠ è½½æ‰€éœ€åŒ…
# ------------------------
packages <- c("openxlsx", "tidyverse", "lefser", "SummarizedExperiment")
for (pkg in packages) {
  if (!requireNamespace(pkg, quietly = TRUE))
    install.packages(pkg)
  library(pkg, character.only = TRUE)
}

# ------------------------
# è®¾ç½®è·¯å¾„
# ------------------------
abundance_dir <- "Abundance"
group_file <- "Group/Group.xlsx"
clinical_file <- "Clinical/Clinical.xlsx"
output_base <- "OutPut"

# ------------------------
# è‡ªåŠ¨è¯»å–å¹¶æ ‡å‡†åŒ–åˆ—åä¸º SampleID
# ------------------------
group_info <- read.xlsx(group_file)
clinical_info <- read.xlsx(clinical_file)

# å°†ç¬¬ä¸€åˆ—ç»Ÿä¸€å‘½åä¸º SampleID
colnames(group_info)[1] <- "SampleID"
colnames(clinical_info)[1] <- "SampleID"
colnames(group_info)[2] <- "Group"

# åˆå¹¶åˆ†ç»„ä¸ä¸´åºŠä¿¡æ¯
meta_full <- left_join(group_info, clinical_info, by = "SampleID")
if (any(is.na(meta_full))) {
  warning("åˆå¹¶åçš„ meta ä¿¡æ¯å­˜åœ¨ NAï¼Œè¯·æ£€æŸ¥ Group.xlsx å’Œ Clinical.xlsx æ ·æœ¬æ˜¯å¦ä¸€è‡´ã€‚")
}

# è®¾ç½®è¡Œä¸ºæ ·æœ¬åï¼Œç§»é™¤ SampleID åˆ—
rownames(meta_full) <- meta_full$SampleID
meta_full <- meta_full[, -which(colnames(meta_full) == "SampleID"), drop = FALSE]
meta_full$Group <- as.factor(meta_full$Group)

# ------------------------
# éå†æ‰€æœ‰ KEGG ä¸°åº¦è¡¨
# ------------------------
abundance_files <- list.files(abundance_dir, pattern = "\\.xlsx$", full.names = TRUE)

for (file in abundance_files) {
  cat("ğŸ” æ­£åœ¨åˆ†æï¼š", file, "\n")
  level_name <- tools::file_path_sans_ext(basename(file))
  level_name <- gsub("KEGG\\.", "", level_name)
  output_dir <- file.path(output_base, level_name)
  if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

  # âœ… ä¸è·³è¿‡ä»»ä½•è¡Œï¼Œå®Œæ•´è¯»å–
  abundance_df <- read.xlsx(file)
  rownames(abundance_df) <- abundance_df[[1]]
  abundance_df <- abundance_df[, -1, drop = FALSE]

  # ä»…ä¿ç•™æ•°å€¼å‹åˆ—
  abundance_df <- abundance_df[, sapply(abundance_df, is.numeric), drop = FALSE]
  abundance_mat <- as.matrix(abundance_df)

  # åŒ¹é…æ ·æœ¬
  matched_samples <- intersect(colnames(abundance_mat), rownames(meta_full))
  if (length(matched_samples) < 2) {
    warning("åŒ¹é…æ ·æœ¬æ•°è¿‡å°‘ï¼Œè·³è¿‡ï¼š", file)
    next
  }
  abundance_mat <- abundance_mat[, matched_samples, drop = FALSE]
  meta_sub <- meta_full[matched_samples, , drop = FALSE]

  # æ„å»º SummarizedExperiment å¯¹è±¡
  se <- SummarizedExperiment(
    assays = SimpleList(exprs = abundance_mat),
    colData = meta_sub
  )

  # âœ… æ’é™¤å…±çº¿æ€§å˜é‡ï¼šä¿ç•™æœ«ç«¯åˆ†ç±»èŠ‚ç‚¹
  terminal_nodes <- get_terminal_nodes(rownames(se))
  se <- se[terminal_nodes, ]

  # ç›¸å¯¹ä¸°åº¦è½¬æ¢
  se <- relativeAb(se)

  # è¿è¡Œ LEfSe åˆ†æ
  set.seed(1234)
  res <- lefser(se, classCol = "Group")

  # ä¿å­˜ç»“æœè¡¨
  write.xlsx(as.data.frame(res), file = file.path(output_dir, "lefse_results.xlsx"), rowNames = TRUE)

  # ä¿å­˜å›¾åƒ
  p <- lefserPlot(res)
  ggsave(file.path(output_dir, "lefse_plot.pdf"), plot = p, width = 8, height = 6)

  cat("âœ… å®Œæˆï¼š", level_name, "\n\n")
}
