# æ¸…ç†ç¯å¢ƒ
rm(list = ls())

# ------------------------
```{r}
# åŠ è½½æ‰€éœ€åŒ…
# ------------------------
base_packages <- c("openxlsx", "tidyverse", "lefser", "SummarizedExperiment")

for (pkg in base_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
  suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}

# ggplot2 å’Œ dplyr å·²åŒ…å«åœ¨ tidyverseï¼Œä¸é‡å¤åŠ è½½

```



```{r}
# ------------------------
abundance_dir <- "Abundance"
group_dir <- "Group"
clinical_dir <- "Clinical"
output_base <- "OutPut"

# ------------------------
# è‡ªåŠ¨è¯†åˆ« Group å’Œ Clinical æ–‡ä»¶
# ------------------------
group_file <- list.files(group_dir, pattern = "\\.xlsx$", full.names = TRUE)[1]
clinical_file <- list.files(clinical_dir, pattern = "\\.xlsx$", full.names = TRUE)[1]

if (is.na(group_file) || is.na(clinical_file)) {
  stop("âŒ Group æˆ– Clinical æ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ° Excel æ–‡ä»¶ï¼Œè¯·ç¡®è®¤è·¯å¾„å’Œæ–‡ä»¶å­˜åœ¨ã€‚")
}

cat("ğŸ“„ æ£€æµ‹åˆ°åˆ†ç»„æ–‡ä»¶ï¼š", basename(group_file), "\n")
cat("ğŸ“„ æ£€æµ‹åˆ°ä¸´åºŠæ–‡ä»¶ï¼š", basename(clinical_file), "\n")
```


# ------------------------
# è®¾ç½®è·¯å¾„

```{r}
# ------------------------
# è¯»å–åˆ†ç»„ä¸ä¸´åºŠä¿¡æ¯
# ------------------------
group_info <- read.xlsx(group_file)
clinical_info <- read.xlsx(clinical_file)

colnames(group_info)[1] <- "SampleID"
colnames(clinical_info)[1] <- "SampleID"
colnames(group_info)[2] <- "Group"

# åˆå¹¶åˆ†ç»„ä¸ä¸´åºŠä¿¡æ¯
meta_full <- left_join(group_info, clinical_info, by = "SampleID")
if (any(is.na(meta_full))) {
  warning("åˆå¹¶åçš„ meta ä¿¡æ¯å­˜åœ¨ NAï¼Œè¯·æ£€æŸ¥ Group.xlsx å’Œ Clinical.xlsx æ ·æœ¬æ˜¯å¦ä¸€è‡´ã€‚")
}

rownames(meta_full) <- meta_full$SampleID
meta_full <- meta_full[, -which(colnames(meta_full) == "SampleID"), drop = FALSE]
meta_full$Group <- as.factor(meta_full$Group)

# ------------------------
```




```{r}
# éå†æ‰€æœ‰ KEGG ä¸°åº¦è¡¨
# ------------------------
abundance_files <- list.files(abundance_dir, pattern = "\\.xlsx$", full.names = TRUE)

for (file in abundance_files) {
  cat("ğŸ” æ­£åœ¨åˆ†æï¼š", file, "\n")
  level_name <- tools::file_path_sans_ext(basename(file))
  level_name <- gsub("KEGG\\.", "", level_name)
  output_dir <- file.path(output_base, level_name)
  if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

  # è¯»å–ä¸°åº¦è¡¨
  abundance_df <- read.xlsx(file)
  rownames(abundance_df) <- abundance_df[[1]]
  abundance_df <- abundance_df[, -1, drop = FALSE]
  abundance_df <- abundance_df[, sapply(abundance_df, is.numeric), drop = FALSE]
  abundance_mat <- as.matrix(abundance_df)

  # åŒ¹é…æ ·æœ¬
  matched_samples <- intersect(colnames(abundance_mat), rownames(meta_full))
  if (length(matched_samples) < 2) {
    warning("åŒ¹é…æ ·æœ¬æ•°è¿‡å°‘ï¼Œè·³è¿‡ï¼š", file)
    next
  }
  abundance_mat <- abundance_mat[, matched_samples, drop = FALSE]
  meta_sub <- meta_full[matched_samples, , drop = FALSE]

  # æ„å»º SummarizedExperiment å¯¹è±¡
  se <- SummarizedExperiment(
    assays = SimpleList(exprs = abundance_mat),
    colData = meta_sub
  )

  # è·å–æœ«ç«¯èŠ‚ç‚¹ï¼ˆæ³¨æ„æ­¤å‡½æ•°éœ€å®šä¹‰æˆ–ä¾èµ–åŒ…æä¾›ï¼‰
  terminal_nodes <- get_terminal_nodes(rownames(se))
  se <- se[terminal_nodes, ]

  # ç›¸å¯¹ä¸°åº¦
  se <- relativeAb(se)

  # LEfSe åˆ†æ
  set.seed(1234)
  res <- lefser(se, classCol = "Group")

  # ä¿å­˜ç»“æœè¡¨
  write.xlsx(as.data.frame(res), file = file.path(output_dir, "lefse_results.xlsx"), rowNames = TRUE)

  # è‡ªå®šä¹‰ ggplot ä½œå›¾
  lda_df <- as.data.frame(res)
  colnames(lda_df) <- c("features", "scores")

  lda_df$class <- ifelse(lda_df$scores > 0, "Group_AN", "Group_HC")
  lda_df <- lda_df %>%
    arrange(scores) %>%
    mutate(order = row_number(),
           class = factor(class, levels = c("Group_HC", "Group_AN")))

  # æŸ±å­æ•°é‡å†³å®šå›¾åƒé«˜åº¦
  n_bars <- nrow(lda_df)
  plot_height <- min(n_bars * 0.2, 20)

  p <- ggplot(lda_df, aes(x = factor(order), y = scores, fill = class)) +
    geom_bar(stat = "identity", width = 0.6, color = "black", size = 0.3) +
    geom_text(aes(y = 0, label = features,
                  hjust = ifelse(scores < 0, 0, 1)),
              nudge_y = ifelse(lda_df$scores < 0, 0.1, -0.1),
              size = 3.5, color = "black") +
    geom_hline(yintercept = 0, color = "black") +
    scale_y_continuous(name = "LDA SCORE (log10)", breaks = pretty(lda_df$scores, n = 5)) +
    scale_fill_manual(values = c("Group_HC" = "lightgreen", "Group_AN" = "orchid")) +
    scale_x_discrete(expand = expansion(mult = c(0, 0))) +
    coord_flip() +
    theme_void(base_size = 13) +
    theme(
      axis.title.x = element_text(size = 11),
      axis.text.x = element_text(size = 10),
      axis.text.y = element_blank(),
      legend.position = "top",
      legend.title = element_blank(),
      panel.grid.major.x = element_line(color = "grey", linewidth = 0.5, linetype = "dotted"),
      panel.grid.minor.x = element_line(color = "grey", linewidth = 0.5, linetype = "dotted")
    )

  # ä¿å­˜å›¾åƒ
  ggsave(file.path(output_dir, "lefse_plot.pdf"), plot = p, width = 8, height = plot_height)

  cat("âœ… å®Œæˆï¼š", level_name, "\n\n")
}
```


